<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cancionero Web</title>
<style>
body { font-family: 'Arial', sans-serif; text-align:center; background:#f5f5f5; margin:0; padding-bottom:50px; }
h1 { color:#2c3e50; margin:20px; font-size:2rem; }
#buscador { margin:10px auto; padding:10px; width:90%; max-width:500px; font-size:16px; border-radius:8px; border:1px solid #ccc; }
.cancion { background:white; margin:10px auto; padding:15px; border-radius:10px; width:90%; max-width:500px; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,0.15); transition:0.3s; }
.cancion:hover { background:#eaf4ff; transform: translateY(-2px);}
.titulo { font-size:1.2rem; font-weight:bold; color:#2980b9; }
.letra { white-space: pre-wrap; font-weight:bold; font-size:1.1rem; line-height:1.6; text-align:center; margin-top:20px; }
#detalle, #repertorio { display:none; padding:20px; }
button { margin-top:10px; padding:10px 20px; border:none; border-radius:10px; cursor:pointer; background:#2980b9; color:white; transition:0.3s;}
button:hover { background:#1a5f91; }
#repertorioLista { margin-top:15px; text-align:left; max-width:90%; margin-left:auto; margin-right:auto; background:#f0f8ff; border-radius:10px; padding:10px; box-shadow:0 3px 6px rgba(0,0,0,0.1);}
.notificacion { background:#27ae60; color:white; padding:10px; border-radius:8px; margin:10px auto; width:90%; max-width:400px; display:none; box-shadow:0 3px 6px rgba(0,0,0,0.1);}
input, select { padding:8px 10px; border-radius:6px; border:1px solid #ccc; margin:5px;}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<h1>üìñ Cancionero</h1>
<div class="notificacion" id="notificacion"></div>
<input type="text" id="buscador" placeholder="üîé Buscar canci√≥n...">
<div id="lista"></div>

<div id="detalle">
  <h2 id="tituloCancion"></h2>
  <div id="letraCancion" class="letra"></div>
  <label for="selectRepertorio">Agregar a repertorio:</label>
  <select id="selectRepertorio"></select>
  <button id="agregarRepertorio">Agregar canci√≥n</button>
  <button id="volver">‚¨Ö Volver</button>
</div>

<div id="repertorio">
  <h2>Mis Repertorios</h2>
  <div>
    <input type="text" id="nuevoRepertorio" placeholder="Nombre del nuevo repertorio">
    <button id="crearRepertorio">Crear Repertorio</button>
  </div>
  <label for="selectMisRepertorios">Seleccionar Repertorio:</label>
  <select id="selectMisRepertorios"></select>
  <div id="repertorioLista"></div>
  <button id="exportarPDF">üìÑ Exportar a PDF</button>
  <button id="volverRepertorio">‚¨Ö Volver</button>
</div>

<script>
let canciones=[], listaFiltrada=[];
let repertorios = JSON.parse(localStorage.getItem("repertorios")) || {};
let repertorioActual = null;

const URL_JSON = "https://cdn.jsdelivr.net/gh/walterrubenhg/ESCOGIDOS/canciones.json?nocache=" + Date.now();

function mostrarNotificacion(msg){
    const n = document.getElementById("notificacion");
    n.textContent = msg;
    n.style.display="block";
    setTimeout(()=>n.style.display="none",3000);
}

// Cargar canciones
fetch(URL_JSON)
.then(res => res.json())
.then(data => {
    canciones = data.canciones || [];
    actualizarLista();
})
.catch(()=>{ canciones = []; actualizarLista(); });

function actualizarLista(){
    const texto = document.getElementById("buscador").value.toLowerCase();
    listaFiltrada = canciones.filter(c => c.titulo.toLowerCase().includes(texto) || c.letra.toLowerCase().includes(texto));
    listaFiltrada.sort((a,b)=>a.titulo.localeCompare(b.titulo));
    const cont = document.getElementById("lista");
    cont.innerHTML = "";
    listaFiltrada.forEach(c=>{
        const div = document.createElement("div");
        div.className="cancion";
        div.textContent=c.titulo;
        div.onclick = ()=>mostrarDetalle(c);
        cont.appendChild(div);
    });
}

function mostrarDetalle(c){
    document.getElementById("lista").style.display="none";
    document.getElementById("buscador").style.display="none";
    document.getElementById("detalle").style.display="block";
    document.getElementById("tituloCancion").textContent = c.titulo;
    document.getElementById("letraCancion").textContent = c.letra;
    actualizarSelectRepertorio();
    document.getElementById("agregarRepertorio").onclick = ()=>{
        if(!repertorioActual) return mostrarNotificacion("Selecciona un repertorio primero");
        if(!repertorios[repertorioActual].includes(c.titulo)){
            repertorios[repertorioActual].push(c.titulo);
            guardarRepertorios();
            mostrarNotificacion(`"${c.titulo}" agregado a "${repertorioActual}"`);
        } else {
            mostrarNotificacion(`"${c.titulo}" ya est√° en "${repertorioActual}"`);
        }
        mostrarRepertorio();
    };
}

document.getElementById("volver").onclick = ()=>{
    document.getElementById("detalle").style.display="none";
    document.getElementById("lista").style.display="block";
    document.getElementById("buscador").style.display="inline-block";
};

function guardarRepertorios(){
    localStorage.setItem("repertorios",JSON.stringify(repertorios));
    actualizarSelectRepertorio();
    actualizarSelectMisRepertorios();
}

function actualizarSelectRepertorio(){
    const select = document.getElementById("selectRepertorio");
    select.innerHTML="";
    for(let r in repertorios){
        const opt = document.createElement("option");
        opt.value=r; opt.textContent=r;
        select.appendChild(opt);
    }
    repertorioActual = select.value || null;
    select.onchange = ()=>repertorioActual=select.value;
}

function actualizarSelectMisRepertorios(){
    const select = document.getElementById("selectMisRepertorios");
    select.innerHTML="";
    for(let r in repertorios){
        const opt = document.createElement("option");
        opt.value=r; opt.textContent=r;
        select.appendChild(opt);
    }
    repertorioActual = select.value || null;
    select.onchange = ()=>{
        repertorioActual = select.value;
        mostrarRepertorio();
    };
}

document.getElementById("crearRepertorio").onclick = ()=>{
    const nombre = document.getElementById("nuevoRepertorio").value.trim();
    if(!nombre) return mostrarNotificacion("Escribe un nombre de repertorio");
    if(repertorios[nombre]) return mostrarNotificacion("Ese repertorio ya existe");
    repertorios[nombre]=[];
    guardarRepertorios();
    document.getElementById("nuevoRepertorio").value="";
    mostrarNotificacion(`Repertorio "${nombre}" creado`);
    mostrarRepertorio();
};

function mostrarRepertorio(){
    document.getElementById("lista").style.display="none";
    document.getElementById("buscador").style.display="none";
    document.getElementById("detalle").style.display="none";
    document.getElementById("repertorio").style.display="block";
    const cont = document.getElementById("repertorioLista");
    if(!repertorioActual){ cont.innerHTML="Selecciona un repertorio"; return;}
    cont.innerHTML="";
    repertorios[repertorioActual].forEach((t,i)=>{
        const div = document.createElement("div");
        div.innerHTML = `${i+1}. ${t} <button onclick="eliminarCancion(${i})">‚ùå</button>`;
        cont.appendChild(div);
    });
}

window.eliminarCancion = function(i){
    if(!repertorioActual) return;
    repertorios[repertorioActual].splice(i,1);
    guardarRepertorios();
    mostrarRepertorio();
}

document.getElementById("exportarPDF").onclick = ()=>{
    if(!repertorioActual) return mostrarNotificacion("Selecciona un repertorio");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text(repertorioActual,105,20,null,null,"center");
    doc.setFontSize(12);
    let y=30;
    repertorios[repertorioActual].forEach((t,i)=>{
        doc.text(`${i+1}. ${t}`,20,y);
        y+=10;
        if(y>280){ doc.addPage(); y=20; }
    });
    doc.save(`${repertorioActual}.pdf`);
}

document.getElementById("volverRepertorio").onclick = ()=>{
    document.getElementById("repertorio").style.display="none";
    document.getElementById("lista").style.display="block";
    document.getElementById("buscador").style.display="inline-block";
};

// Inicializar
actualizarSelectRepertorio();
actualizarSelectMisRepertorios();
document.getElementById("buscador").addEventListener("input", actualizarLista);

</script>
</body>
</html>
