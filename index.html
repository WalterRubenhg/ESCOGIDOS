<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cancionero Web</title>
<style>
body { 
    font-family: 'Arial', sans-serif; 
    text-align:center; 
    background:#f5f5f5; 
    margin:0; 
    padding-bottom: 50px;
}
h1 { 
    color:#2c3e50; 
    margin:20px; 
    font-size:2rem;
}
#buscador { 
    margin:10px auto; 
    padding:10px; 
    width:90%; 
    max-width:500px; 
    font-size:16px; 
    border-radius:8px; 
    border:1px solid #ccc; 
}
.cancion { 
    background:white; 
    margin:10px auto; 
    padding:15px; 
    border-radius:10px; 
    width:90%; 
    max-width:500px;
    cursor:pointer; 
    box-shadow:0 4px 10px rgba(0,0,0,0.15); 
    transition:0.3s; 
}
.cancion:hover { 
    background:#eaf4ff; 
    transform: translateY(-2px);
}
.titulo { 
    font-size:1.2rem; 
    font-weight:bold; 
    color:#2980b9; 
}
.letra { 
    white-space: pre-wrap; 
    font-weight:bold; 
    font-size:1.1rem; 
    line-height:1.6; 
    text-align:center; 
    margin-top:20px; 
}
#detalle, #repertorio { 
    display:none; 
    padding:20px; 
}
#volver, #guardarRepertorio, #volverRepertorio, #exportarPDF { 
    margin-top:20px; 
    padding:10px 25px; 
    font-size:1rem; 
    border:none; 
    border-radius:10px; 
    background:#2980b9; 
    color:white; 
    cursor:pointer; 
    transition:0.3s;
}
#volver:hover, #guardarRepertorio:hover, #volverRepertorio:hover, #exportarPDF:hover { 
    background:#1a5f91; 
}
.botonTutorial { 
    margin:5px; 
    padding:10px 20px; 
    font-size:1rem; 
    border-radius:10px; 
    border:none; 
    cursor:pointer; 
    background:#e67e22; 
    color:white; 
    transition:0.3s;
}
.botonTutorial:hover { 
    background:#d35400; 
}
#repertorioLista { 
    margin-top:15px; 
    text-align:left; 
    max-width:90%; 
    margin-left:auto; 
    margin-right:auto; 
    background:#f0f8ff; 
    border-radius:10px; 
    padding:10px; 
    box-shadow:0 3px 6px rgba(0,0,0,0.1);
}
.notificacion { 
    background:#27ae60; 
    color:white; 
    padding:10px; 
    border-radius:8px; 
    margin:10px auto; 
    width:90%; 
    max-width:400px; 
    display:none; 
    box-shadow:0 3px 6px rgba(0,0,0,0.1);
}

/* Modal */
.modal { 
    display:none; 
    position:fixed; 
    z-index:999; 
    left:0; 
    top:0; 
    width:100%; 
    height:100%; 
    overflow:auto; 
    background-color:rgba(0,0,0,0.7); 
}
.modal-content { 
    background-color:#fefefe; 
    margin:10% auto; 
    padding:0; 
    border-radius:10px; 
    width:90%; 
    max-width:800px; 
    position:relative; 
}
.modal iframe { 
    width:100%; 
    height:400px; 
    border:none; 
    border-radius:10px 10px 0 0; 
}
.close { 
    color:white; 
    position:absolute; 
    top:10px; 
    right:20px; 
    font-size:30px; 
    font-weight:bold; 
    cursor:pointer; 
}
.close:hover { 
    color:#ccc; 
}

/* Responsive */
@media (max-width: 600px){
    .botonTutorial, #volver, #guardarRepertorio, #volverRepertorio, #exportarPDF { width:80%; margin:5px auto; }
    .letra { font-size:1rem; }
    .titulo { font-size:1rem; }
}
</style>

<!-- LibrerÃ­a jsPDF para exportar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<h1>ðŸ“– Cancionero </h1>
<div class="notificacion" id="notificacion">Â¡Hay canciones nuevas disponibles!</div>
<input type="text" id="buscador" placeholder="ðŸ”Ž Buscar canciÃ³n...">
<div id="lista"></div>

<div id="detalle">
  <h2 id="tituloCancion"></h2>
  <div class="tutorial">
    <button class="botonTutorial" id="btnTeclado">Teclado</button>
    <button class="botonTutorial" id="btnBateria">BaterÃ­a</button>
    <button class="botonTutorial" id="btnGuitarra">Guitarra</button>
    <button class="botonTutorial" id="btnMusica">Reproducir CanciÃ³n</button>
  </div>
  <div id="letraCancion" class="letra"></div>
  <button id="volver">â¬… Volver</button>
</div>

<div id="repertorio">
  <h2>Repertorios Semanales</h2>
  <label for="selectDomingo">Seleccionar Domingo:</label>
  <select id="selectDomingo">
    <option value="domingo1">Domingo 1</option>
    <option value="domingo2">Domingo 2</option>
    <option value="domingo3">Domingo 3</option>
  </select>
  <div id="repertorioLista"></div>
  <button id="guardarRepertorio">ðŸ’¾ Guardar Repertorio</button>
  <button id="exportarPDF">ðŸ“„ Exportar a PDF</button>
  <button id="volverRepertorio">â¬… Volver</button>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <iframe id="iframeModal" allow="autoplay; encrypted-media" allowfullscreen></iframe>
  </div>
</div>

<script>
let canciones=[], listaFiltrada=[];
let repertorios = JSON.parse(localStorage.getItem("repertoriosDomingos")) || {
    domingo1: [],
    domingo2: [],
    domingo3: []
};
let domingoActual = "domingo1";

const URL_JSON = "https://cdn.jsdelivr.net/gh/walterrubenhg/ESCOGIDOS/canciones.json?nocache=" + Date.now();

function mostrarNotificacion() {
    const n = document.getElementById("notificacion");
    n.style.display = "block";
    setTimeout(() => n.style.display = "none", 4000);
}

// Cargar canciones y comparar con localStorage
fetch(URL_JSON)
.then(res => res.json())
.then(data => {
    let guardadas = localStorage.getItem("canciones");
    if(!guardadas || JSON.stringify(JSON.parse(guardadas)) !== JSON.stringify(data.canciones)){
        canciones = data.canciones;
        localStorage.setItem("canciones", JSON.stringify(data.canciones));
        mostrarNotificacion();
    } else {
        canciones = JSON.parse(guardadas);
    }
    actualizarLista();
})
.catch(() => {
    let guardadas = localStorage.getItem("canciones");
    canciones = guardadas ? JSON.parse(guardadas) : [];
    actualizarLista();
});

function actualizarLista(){
    const texto=document.getElementById("buscador").value.toLowerCase();
    listaFiltrada=canciones.filter(c => c.titulo.toLowerCase().includes(texto) || c.letra.toLowerCase().includes(texto));
    listaFiltrada.sort((a,b) => a.titulo.localeCompare(b.titulo));
    const cont=document.getElementById("lista");
    cont.innerHTML="";
    listaFiltrada.forEach(c=>{
        const div=document.createElement("div");
        div.className="cancion";
        div.innerHTML=`<div class="titulo">${c.titulo}</div>`;
        div.onclick = () => mostrarDetalle(c);
        div.oncontextmenu = (e) => { e.preventDefault(); agregarAlRepertorio(c); };
        cont.appendChild(div);
    });
}

function mostrarDetalle(c){
    document.getElementById("lista").style.display="none";
    document.getElementById("buscador").style.display="none";
    document.getElementById("detalle").style.display="block";
    document.getElementById("tituloCancion").textContent=c.titulo;
    document.getElementById("letraCancion").textContent=c.letra;

    const modal=document.getElementById("modal");
    const iframe=document.getElementById("iframeModal");
    const close=document.getElementsByClassName("close")[0];

    document.getElementById("btnTeclado").onclick = () => { iframe.src=c.tutorial.teclado; modal.style.display="block"; };
    document.getElementById("btnBateria").onclick = () => { iframe.src=c.tutorial.bateria; modal.style.display="block"; };
    document.getElementById("btnGuitarra").onclick = () => { iframe.src=c.tutorial.guitarra; modal.style.display="block"; };
    document.getElementById("btnMusica").onclick = () => { iframe.src=c.audio; modal.style.display="block"; };

    close.onclick = () => { iframe.src=""; modal.style.display="none"; };
    window.onclick = (event) => { if(event.target == modal){ iframe.src=""; modal.style.display="none"; } };
}

document.getElementById("volver").onclick = () => {
    document.getElementById("detalle").style.display="none";
    document.getElementById("lista").style.display="block";
    document.getElementById("buscador").style.display="inline-block";
};

// --- Repertorios ---
const selectDomingo = document.getElementById("selectDomingo");
selectDomingo.onchange = () => {
    domingoActual = selectDomingo.value;
    mostrarRepertorio();
};

function agregarAlRepertorio(c){
    if(!repertorios[domingoActual].includes(c.titulo)){
        repertorios[domingoActual].push(c.titulo);
        mostrarRepertorio();
        alert(`"${c.titulo}" agregado al ${domingoActual}`);
    } else {
        alert(`"${c.titulo}" ya estÃ¡ en el ${domingoActual}`);
    }
}

function mostrarRepertorio(){
    document.getElementById("lista").style.display="none";
    document.getElementById("buscador").style.display="none";
    document.getElementById("detalle").style.display="none";
    document.getElementById("repertorio").style.display="block";
    const cont = document.getElementById("repertorioLista");
    cont.innerHTML = repertorios[domingoActual].map((t,i)=>`${i+1}. ${t}`).join("<br>");
}

document.getElementById("guardarRepertorio").onclick = () => {
    localStorage.setItem("repertoriosDomingos", JSON.stringify(repertorios));
    alert(`Repertorio guardado para ${domingoActual}!`);
};

document.getElementById("exportarPDF").onclick = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text("Repertorio " + domingoActual, 105, 20, null, null, "center");

    doc.setFontSize(12);
    let y = 30;
    repertorios[domingoActual].forEach((titulo, i) => {
        doc.text(`${i + 1}. ${titulo}`, 20, y);
        y += 10;
        if(y > 280){
            doc.addPage();
            y = 20;
        }
    });

    doc.save(`Repertorio_${domingoActual}.pdf`);
};

document.getElementById("volverRepertorio").onclick = () => {
    document.getElementById("repertorio").style.display="none";
    document.getElementById("lista").style.display="block";
    document.getElementById("buscador").style.display="inline-block";
};

// Cargar repertorio al iniciar
mostrarRepertorio();
document.getElementById("buscador").addEventListener("input", actualizarLista);
</script>
</body>
</html>
